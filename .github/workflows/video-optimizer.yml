name: Video Optimizer Gurbani Kirtan Darbar

on:
  repository_dispatch:
    types: [compress_mp4]

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      # üßæ Checkout repo
      - name: Checkout repo
        uses: actions/checkout@v4

      # üõ† Install FFmpeg
      - name: Install FFmpeg
        run: |
          sudo apt update
          sudo apt install -y ffmpeg

      - name: Verify FFmpeg
        run: ffmpeg -version

      # ‚¨áÔ∏è Download source video
      - name: Download source video
        run: |
          echo "Downloading video:"
          echo "${{ github.event.client_payload.video_url }}"
          curl -L "${{ github.event.client_payload.video_url }}" -o input_video
          ls -lh input_video

      # üé• Step 1: Compress + Compare
      - name: Smart compress and choose smaller file
        run: |
          set -e

          ffmpeg -y -i input_video \
            -vf "scale='if(gt(iw,ih),min(1920,iw),-2)':'if(gt(ih,iw),min(1080,ih),-2)',format=yuv420p,fps=30" \
            -c:v libx264 \
            -profile:v baseline \
            -level 3.0 \
            -preset veryfast \
            -crf 23 \
            -c:a aac \
            -b:a 128k \
            -ar 48000 \
            compressed.mp4

          ORIGINAL_SIZE=$(stat -c%s input_video)
          COMPRESSED_SIZE=$(stat -c%s compressed.mp4)

          if [ "$COMPRESSED_SIZE" -lt "$ORIGINAL_SIZE" ]; then
            echo "SELECTED_INPUT=compressed.mp4" >> $GITHUB_ENV
          else
            echo "SELECTED_INPUT=input_video" >> $GITHUB_ENV
          fi

      # üé¨ Step 2: Create FINAL stream MP4 (no logo)
      - name: Create final MP4 (streaming)
        run: |
          mkdir -p output_mp4

          ffmpeg -y -i "$SELECTED_INPUT" \
            -vf "scale='if(gt(iw,ih),min(1920,iw),-2)':'if(gt(ih,iw),min(1080,ih),-2)',format=yuv420p,fps=30" \
            -c:v libx264 \
            -profile:v baseline \
            -level 3.0 \
            -preset veryfast \
            -crf 23 \
            -pix_fmt yuv420p \
            -c:a aac \
            -b:a 128k \
            -movflags +faststart \
            output_mp4/final.mp4

      # üé® Step 3: Create branded MP4
      - name: Create branded MP4
        run: |
          ffmpeg -y \
            -i output_mp4/final.mp4 \
            -i logo.png \
            -filter_complex "\
              [1:v]scale=iw*0.25:-1[logo]; \
              [0:v][logo]overlay=main_w-overlay_w-(main_w*0.03):(main_h*0.03) \
            " \
            -c:v libx264 \
            -preset veryfast \
            -crf 23 \
            -pix_fmt yuv420p \
            -c:a aac \
            -b:a 128k \
            -movflags +faststart \
            output_mp4/branded.mp4

      # ‚òÅÔ∏è Upload FINAL MP4 (stream)
      - name: Upload final MP4
        env:
          MP4_SECRET: ${{ secrets.UPLOAD_SECRET }}
        run: |
          BASE_KEY=$(echo "${{ github.event.client_payload.original_key }}" | sed 's|/|_|g' | sed 's|\.[^.]*$||')

          curl -X POST \
            -H "X-MP4-Secret: $MP4_SECRET" \
            -H "Content-Type: video/mp4" \
            --data-binary @"output_mp4/final.mp4" \
            "https://gurbani-kirtan-darbar.iemgurpreets.workers.dev/upload?key=Stream/user/${BASE_KEY}.mp4"

      # ‚òÅÔ∏è Upload BRANDED MP4 (download)
      - name: Upload branded MP4
        env:
          MP4_SECRET: ${{ secrets.UPLOAD_SECRET }}
        run: |
          BASE_KEY=$(echo "${{ github.event.client_payload.original_key }}" | sed 's|/|_|g' | sed 's|\.[^.]*$||')

          curl -X POST \
            -H "X-MP4-Secret: $MP4_SECRET" \
            -H "Content-Type: video/mp4" \
            --data-binary @"output_mp4/branded.mp4" \
            "https://gurbani-kirtan-darbar.iemgurpreets.workers.dev/upload?key=Stream/download/${BASE_KEY}.mp4"

      # üî• Firestore update
      - name: Update Firestore
        env:
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_CLIENT_EMAIL: ${{ secrets.FIREBASE_CLIENT_EMAIL }}
          FIREBASE_PRIVATE_KEY: ${{ secrets.FIREBASE_PRIVATE_KEY }}
        run: |
          node <<'EOF'
          const admin = require("firebase-admin");

          admin.initializeApp({
            credential: admin.credential.cert({
              projectId: process.env.FIREBASE_PROJECT_ID,
              clientEmail: process.env.FIREBASE_CLIENT_EMAIL,
              privateKey: process.env.FIREBASE_PRIVATE_KEY.replace(/\\n/g, "\n"),
            }),
          });

          const db = admin.firestore();
          const publicId = "${{ github.event.client_payload.original_key }}";

          const baseKey = publicId.replace(/^Videos\//, "").replace(/\.[^.]+$/, "");

          const streamUrl =
            "https://gurbani-kirtan-darbar.iemgurpreets.workers.dev?filename=Stream/user/" + baseKey + ".mp4";

          const brandedUrl =
            "https://gurbani-kirtan-darbar.iemgurpreets.workers.dev?filename=Stream/download/" + baseKey + ".mp4";

          async function updateFirestore() {
            for (const col of ["pending_posts", "posts"]) {
              const snap = await db.collection(col).where("publicId", "==", publicId).limit(1).get();
              if (!snap.empty) {
                await snap.docs[0].ref.update({
                  imageUrl: streamUrl,
                  brandedVideo: brandedUrl,
                  mediaType: "Video",
                  publicId
                });
                return;
              }
            }
          }

          updateFirestore();
          EOF
