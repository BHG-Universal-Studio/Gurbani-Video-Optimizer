name: HLS Conversion Gurbani Kirtan Darbar

on:
  repository_dispatch:
    types: [convert_hls]

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      # üßæ Checkout repo
      - name: Checkout repo
        uses: actions/checkout@v4

      # üõ† Install FFmpeg
      - name: Install FFmpeg
        run: |
          sudo apt update
          sudo apt install -y ffmpeg

      - name: Verify FFmpeg
        run: ffmpeg -version

      # ‚¨áÔ∏è Download source video
      - name: Download source video
        run: |
          echo "Downloading video:"
          echo "${{ github.event.client_payload.video_url }}"
          curl -L "${{ github.event.client_payload.video_url }}" -o input_video
          ls -lh input_video

      # üé• Convert ‚Üí Compress ‚Üí HLS
      - name: Convert to HLS (FINAL)
        run: |
          set -e
          mkdir -p output_hls

          ffmpeg -y -i input_video \
            -vf "scale='if(gt(iw,ih),min(1920,iw),-2)':'if(gt(ih,iw),min(1080,ih),-2)',fps=30" \
            -c:v libx264 -preset veryfast -crf 23 \
            -c:a aac -b:a 128k \
            compressed.mp4

          if [ "$(stat -c%s compressed.mp4)" -lt "$(stat -c%s input_video)" ]; then
            SELECTED_INPUT="compressed.mp4"
          else
            SELECTED_INPUT="input_video"
          fi

          echo "HLS_INPUT=$SELECTED_INPUT" >> $GITHUB_ENV

          ffmpeg -y -i "$SELECTED_INPUT" \
            -vf "scale='if(gt(iw,ih),min(1920,iw),-2)':'if(gt(ih,iw),min(1080,ih),-2)',fps=30" \
            -c:v libx264 -preset veryfast -crf 23 \
            -g 180 -keyint_min 180 -sc_threshold 0 \
            -c:a aac -b:a 128k \
            -hls_time 6 -hls_playlist_type vod -hls_list_size 0 \
            -hls_segment_filename "output_hls/index%03d.ts" \
            output_hls/index.m3u8

      # üîó Rewrite playlist URLs
      - name: Rewrite HLS playlist
        run: |
          BASE_KEY=$(echo "${{ github.event.client_payload.original_key }}" | sed 's|/|_|g' | sed 's|\.[^.]*$||')
          BASE_URL="https://gurbani-kirtan-darbar.iemgurpreets.workers.dev?filename=hls/${BASE_KEY}"
          sed -i "s|index|$BASE_URL/index|g" output_hls/index.m3u8

        # üé® Branded MP4 (TOP-RIGHT LOGO, CONSISTENT SIZE)
      - name: Create branded MP4
        run: |
          mkdir -p output_mp4
          ffmpeg -y -i "$HLS_INPUT" -i logo.png \
            -filter_complex "\
              [0:v]scale='if(gt(iw,ih),min(1920,iw),-2)':'if(gt(ih,iw),min(1080,ih),-2)'[v]; \
              [1:v]scale=iw*0.18:-1[logo]; \
              [v][logo]overlay=x=W-w-(W*0.03):y=H*0.03 \
            " \
            -c:v libx264 -preset veryfast -crf 23 \
            -c:a aac -b:a 128k \
            -movflags +faststart \
            output_mp4/branded.mp4


      # ‚òÅÔ∏è Upload HLS to R2 (Worker)
      - name: Upload HLS
        env:
          HLS_SECRET: ${{ secrets.HLS_UPLOAD_SECRET }}
        run: |
          BASE_KEY=$(echo "${{ github.event.client_payload.original_key }}" | sed 's|/|_|g' | sed 's|\.[^.]*$||')
          for file in output_hls/*; do
            curl -X POST \
              -H "X-HLS-Secret: $HLS_SECRET" \
              --data-binary @"$file" \
              "https://gurbani-kirtan-darbar.iemgurpreets.workers.dev/hls/upload?key=hls/${BASE_KEY}/$(basename "$file")"
          done

      - name: Upload branded MP4
        env:
          HLS_SECRET: ${{ secrets.HLS_UPLOAD_SECRET }}
        run: |
          BASE_KEY=$(echo "${{ github.event.client_payload.original_key }}" | sed 's|/|_|g' | sed 's|\.[^.]*$||')
          curl -X POST \
            -H "X-HLS-Secret: $HLS_SECRET" \
            --data-binary @"output_mp4/branded.mp4" \
            "https://gurbani-kirtan-darbar.iemgurpreets.workers.dev/hls/upload?key=hls/${BASE_KEY}/branded/branded.mp4"


      # üî• Install firebase-admin
      - name: Install firebase-admin
        run: |
          npm init -y
          npm install firebase-admin
      # üî• Firestore update OR mark cleanup
      - name: Update Firestore or mark cleanup
        env:
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_CLIENT_EMAIL: ${{ secrets.FIREBASE_CLIENT_EMAIL }}
          FIREBASE_PRIVATE_KEY: ${{ secrets.FIREBASE_PRIVATE_KEY }}
        run: |
          node <<'EOF'
          const admin = require("firebase-admin");
          const fs = require("fs");

          admin.initializeApp({
            credential: admin.credential.cert({
              projectId: process.env.FIREBASE_PROJECT_ID,
              clientEmail: process.env.FIREBASE_CLIENT_EMAIL,
              privateKey: process.env.FIREBASE_PRIVATE_KEY.replace(/\\n/g, "\n"),
            }),
          });

          const db = admin.firestore();
          const publicId = "${{ github.event.client_payload.original_key }}";
          const baseKey = publicId.replace(/\//g, "_").replace(/\.[^.]+$/, "");
          const prefix = "hls/" + baseKey;

          async function run() {
            for (const col of ["pending_posts", "posts", "rejectedPosts"]) {
              const snap = await db.collection(col).where("publicId", "==", publicId).limit(1).get();
              if (!snap.empty) {
                await snap.docs[0].ref.update({
                  hlsUrl: `https://gurbani-kirtan-darbar.iemgurpreets.workers.dev?filename=${prefix}/index.m3u8`,
                  brandedVideo: `https://gurbani-kirtan-darbar.iemgurpreets.workers.dev?filename=${prefix}/branded/branded.mp4`,
                  publicHlsId: prefix
                });
                fs.appendFileSync(process.env.GITHUB_ENV, "CLEANUP=false\n");
                return;
              }
            }
            fs.appendFileSync(process.env.GITHUB_ENV, "CLEANUP=true\n");
            fs.appendFileSync(process.env.GITHUB_ENV, `PREFIX=${prefix}\n`);
          }
          run();
          EOF

      # üßπ CLEANUP orphaned media (same workflow)
      - name: Cleanup orphaned HLS from R2
        if: env.CLEANUP == 'true'
        run: |
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o awscliv2.zip
          unzip awscliv2.zip
          sudo ./aws/install --update

          aws configure set aws_access_key_id ${{ secrets.R2_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.R2_SECRET_ACCESS_KEY }}
          aws configure set default.region auto

          ENDPOINT="https://${{ secrets.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com"
          aws s3 rm "s3://${{ secrets.R2_BUCKET_NAME }}/$PREFIX" --recursive --endpoint-url "$ENDPOINT"
