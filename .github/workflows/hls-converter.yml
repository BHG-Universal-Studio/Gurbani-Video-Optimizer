name: HLS Conversion Gurbani Kirtan Darbar

on:
  repository_dispatch:
    types: [convert_hls]

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      # üßæ Checkout repo
      - name: Checkout repo
        uses: actions/checkout@v4

      # üõ† Install FFmpeg
      - name: Install FFmpeg
        run: |
          sudo apt update
          sudo apt install -y ffmpeg

      - name: Verify FFmpeg
        run: ffmpeg -version

      # ‚¨áÔ∏è Download source video from Cloudflare Worker
      - name: Download source video
        run: |
          echo "Downloading video from:"
          echo "${{ github.event.client_payload.video_url }}"

          curl -L "${{ github.event.client_payload.video_url }}" -o input_video

          echo "Downloaded file:"
          ls -lh input_video

  
      - name: Convert to HLS (Feed Optimized ‚Äì FINAL)
        run: |
         mkdir -p output_hls

         ffmpeg -y -i input_video \
         -vf "scale='if(gt(iw,ih),min(1920,iw),-2)':'if(gt(ih,iw),min(1080,ih),-2)':flags=lanczos,format=yuv420p,fps=30" \
         -r 30 \
         -c:v libx264 \
         -profile:v baseline \
         -level 3.0 \
         -preset veryfast \
         -crf 23 \
         -g 180 \
         -keyint_min 180 \
         -sc_threshold 0 \
         -c:a aac \
         -b:a 128k \
         -ar 48000 \
         -hls_time 6 \
         -hls_playlist_type vod \
         -hls_list_size 0 \
         -hls_segment_filename "output_hls/index%03d.ts" \
         output_hls/index.m3u8




      # üîó Rewrite HLS playlist to ABSOLUTE URLs (üî• REQUIRED)
      - name: Rewrite HLS playlist to absolute URLs
        run: |
          BASE_KEY=$(echo "${{ github.event.client_payload.original_key }}" \
            | sed 's|/|_|g' \
            | sed 's|\.[^.]*$||')

          BASE_URL="https://gurbani-kirtan-darbar.iemgurpreets.workers.dev?filename=hls/${BASE_KEY}"

          sed -i "s|index|$BASE_URL/index|g" output_hls/index.m3u8

          echo "Final playlist:"
          cat output_hls/index.m3u8

      # üìÇ Debug
      - name: List HLS output
        run: ls -lh output_hls

      # ‚òÅÔ∏è Upload HLS files to Cloudflare R2 via Worker
      - name: Upload HLS to Cloudflare via Worker
        env:
          HLS_SECRET: ${{ secrets.HLS_UPLOAD_SECRET }}
        run: |
          BASE_KEY=$(echo "${{ github.event.client_payload.original_key }}" \
            | sed 's|/|_|g' \
            | sed 's|\.[^.]*$||')

          for file in output_hls/*; do
            NAME=$(basename "$file")

            curl -X POST \
              -H "X-HLS-Secret: $HLS_SECRET" \
              -H "Content-Type: $(file --mime-type -b "$file")" \
              --data-binary @"$file" \
              "https://gurbani-kirtan-darbar.iemgurpreets.workers.dev/hls/upload?key=hls/${BASE_KEY}/${NAME}"
          done



      - name: Install firebase-admin
        run: |
          npm init -y
          npm install firebase-admin

          
   
      - name: Update Firestore with HLS URL
        env:
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_CLIENT_EMAIL: ${{ secrets.FIREBASE_CLIENT_EMAIL }}
          FIREBASE_PRIVATE_KEY: ${{ secrets.FIREBASE_PRIVATE_KEY }}
        run: |
          node <<'EOF'
          const admin = require("firebase-admin");

          admin.initializeApp({
            credential: admin.credential.cert({
              projectId: process.env.FIREBASE_PROJECT_ID,
              clientEmail: process.env.FIREBASE_CLIENT_EMAIL,
              privateKey: process.env.FIREBASE_PRIVATE_KEY.replace(/\\n/g, "\n"),
            }),
          });

          const db = admin.firestore();

          const publicId = "${{ github.event.client_payload.original_key }}";
          const baseKey = publicId.replace(/\//g, "_").replace(/\.[^.]+$/, "");
          const hlsUrl =
            "https://gurbani-kirtan-darbar.iemgurpreets.workers.dev" +
            "?filename=hls/" + baseKey + "/index.m3u8";

          async function updateFirestore() {
            for (const col of ["pending_posts", "posts"]) {
              const snap = await db
                .collection(col)
                .where("publicId", "==", publicId)
                .limit(1)
                .get();

              if (!snap.empty) {
                await snap.docs[0].ref.update({
                  hlsUrl,
                  publicHlsId: "hls/" + baseKey,
                });

                console.log(`Firestore updated in ${col}`);
                return;
              }
            }
            console.log("No matching document found");
          }

          updateFirestore();
          EOF
