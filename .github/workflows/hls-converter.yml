name: HLS Conversion Gurbani Kirtan Darbar

on:
  repository_dispatch:
    types: [convert_hls]

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      # ğŸ§¾ Checkout repo
      - name: Checkout repo
        uses: actions/checkout@v4

      # ğŸ›  Install FFmpeg
      - name: Install FFmpeg
        run: |
          sudo apt update
          sudo apt install -y ffmpeg

      - name: Verify FFmpeg
        run: ffmpeg -version

      # â¬‡ï¸ Download source video
      - name: Download source video
        run: |
          curl -L "${{ github.event.client_payload.video_url }}" -o input_video
          ls -lh input_video

      # ğŸ¥ Smart compress â†’ compare â†’ multi-bitrate HLS
      - name: Convert to Multi-Bitrate HLS
        run: |
          set -e
          mkdir -p output_hls/videohigh output_hls/videolow

          echo "ğŸ”¹ Step 1: Compress candidate"
          ffmpeg -y -i input_video \
            -vf "scale='if(gt(iw,ih),min(1920,iw),-2)':'if(gt(ih,iw),min(1080,ih),-2)',fps=30,format=yuv420p" \
            -c:v libx264 \
            -preset veryfast \
            -crf 23 \
            -c:a aac \
            -b:a 128k \
            compressed.mp4

          echo "ğŸ”¹ Step 2: Compare sizes"
          ORIGINAL_SIZE=$(stat -c%s input_video)
          COMPRESSED_SIZE=$(stat -c%s compressed.mp4)

          echo "Original:   $ORIGINAL_SIZE bytes"
          echo "Compressed: $COMPRESSED_SIZE bytes"

          if [ "$COMPRESSED_SIZE" -lt "$ORIGINAL_SIZE" ]; then
            echo "âœ… Using compressed.mp4"
            HLS_INPUT="compressed.mp4"
          else
            echo "âœ… Using original input_video"
            HLS_INPUT="input_video"
          fi

          echo "ğŸ”¹ Step 3a: High quality HLS (1080p max)"
          ffmpeg -y -i "$HLS_INPUT" \
            -vf "scale='if(gt(iw,ih),min(1920,iw),-2)':'if(gt(ih,iw),min(1080,ih),-2)',fps=30,format=yuv420p" \
            -c:v libx264 \
            -preset veryfast \
            -crf 23 \
            -g 180 \
            -keyint_min 180 \
            -sc_threshold 0 \
            -c:a aac \
            -b:a 128k \
            -hls_time 6 \
            -hls_playlist_type vod \
            -hls_list_size 0 \
            -hls_segment_filename "output_hls/videohigh/index%03d.ts" \
            output_hls/videohigh/index.m3u8

          echo "ğŸ”¹ Step 3b: Low quality HLS (480p)"
          ffmpeg -y -i "$HLS_INPUT" \
            -vf "scale='if(gt(iw,ih),854,-2)':'if(gt(ih,iw),480,-2)',fps=30,format=yuv420p" \
            -c:v libx264 \
            -preset veryfast \
            -crf 28 \
            -g 180 \
            -keyint_min 180 \
            -sc_threshold 0 \
            -c:a aac \
            -b:a 96k \
            -hls_time 6 \
            -hls_playlist_type vod \
            -hls_list_size 0 \
            -hls_segment_filename "output_hls/videolow/index%03d.ts" \
            output_hls/videolow/index.m3u8

          echo "ğŸ”¹ Step 4: Create master playlist"
          cat > output_hls/index.m3u8 <<EOF
          #EXTM3U
          #EXT-X-VERSION:3

          #EXT-X-STREAM-INF:BANDWIDTH=2500000,RESOLUTION=1920x1080
          videohigh/index.m3u8

          #EXT-X-STREAM-INF:BANDWIDTH=800000,RESOLUTION=854x480
          videolow/index.m3u8
          EOF

      # ğŸ”— Rewrite playlists to absolute URLs
      - name: Rewrite playlists to absolute URLs
        run: |
          BASE_KEY=$(echo "${{ github.event.client_payload.original_key }}" | sed 's|/|_|g' | sed 's|\.[^.]*$||')
          BASE_URL="https://gurbani-kirtan-darbar.iemgurpreets.workers.dev?filename=hls/${BASE_KEY}"

          find output_hls -name "*.m3u8" -exec \
            sed -i "s|videohigh|$BASE_URL/videohigh|g; s|videolow|$BASE_URL/videolow|g" {} +

      # â˜ï¸ Upload HLS to Cloudflare R2 via Worker
      - name: Upload HLS to Cloudflare Worker
        env:
          HLS_SECRET: ${{ secrets.HLS_UPLOAD_SECRET }}
        run: |
          BASE_KEY=$(echo "${{ github.event.client_payload.original_key }}" | sed 's|/|_|g' | sed 's|\.[^.]*$||')

          find output_hls -type f | while read file; do
            REL=${file#output_hls/}
            curl -X POST \
              -H "X-HLS-Secret: $HLS_SECRET" \
              -H "Content-Type: $(file --mime-type -b "$file")" \
              --data-binary @"$file" \
              "https://gurbani-kirtan-darbar.iemgurpreets.workers.dev/hls/upload?key=hls/${BASE_KEY}/${REL}"
          done

      # ğŸ”¥ Update Firestore (Node 20 SAFE)
      - name: Update Firestore
        env:
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_CLIENT_EMAIL: ${{ secrets.FIREBASE_CLIENT_EMAIL }}
          FIREBASE_PRIVATE_KEY: ${{ secrets.FIREBASE_PRIVATE_KEY }}
        run: |
          node --input-type=module <<'EOF'
          import admin from "firebase-admin";

          admin.initializeApp({
            credential: admin.credential.cert({
              projectId: process.env.FIREBASE_PROJECT_ID,
              clientEmail: process.env.FIREBASE_CLIENT_EMAIL,
              privateKey: process.env.FIREBASE_PRIVATE_KEY.replace(/\\n/g, "\n"),
            }),
          });

          const db = admin.firestore();

          const publicId = "${{ github.event.client_payload.original_key }}";
          const baseKey = publicId.replace(/\//g, "_").replace(/\.[^.]+$/, "");

          const hlsUrl =
            "https://gurbani-kirtan-darbar.iemgurpreets.workers.dev" +
            "?filename=hls/" + baseKey + "/index.m3u8";

          for (const col of ["pending_posts", "posts"]) {
            const snap = await db
              .collection(col)
              .where("publicId", "==", publicId)
              .limit(1)
              .get();

            if (!snap.empty) {
              await snap.docs[0].ref.update({
                hlsUrl,
                publicHlsId: "hls/" + baseKey,
              });
              console.log(`âœ… Firestore updated in ${col}`);
              break;
            }
          }
          EOF


      - name: Debug HLS sizes
        run: |
          echo "ğŸ“¦ HLS Size Summary"

          HIGH_SIZE_BYTES=$(du -cb output_hls/videohigh/* | tail -1 | cut -f1)
          LOW_SIZE_BYTES=$(du -cb output_hls/videolow/* | tail -1 | cut -f1)

          HIGH_SIZE_MB=$(awk "BEGIN {printf \"%.2f\", $HIGH_SIZE_BYTES/1024/1024}")
          LOW_SIZE_MB=$(awk "BEGIN {printf \"%.2f\", $LOW_SIZE_BYTES/1024/1024}")
          TOTAL_MB=$(awk "BEGIN {printf \"%.2f\", ($HIGH_SIZE_BYTES+$LOW_SIZE_BYTES)/1024/1024}")

          echo "ğŸ”¹ High Quality HLS  : $HIGH_SIZE_MB MB"
          echo "ğŸ”¹ Low Quality HLS   : $LOW_SIZE_MB MB"
          echo "ğŸ”¹ Total HLS Size    : $TOTAL_MB MB"

