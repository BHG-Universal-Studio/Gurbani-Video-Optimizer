name: Delete HLS from R2

on:
  repository_dispatch:
    types: [delete_hls]

jobs:
  delete:
    runs-on: ubuntu-latest

    steps:
      - name: Setup environment
        run: |
          echo "PREFIX=${{ github.event.client_payload.prefix }}" >> $GITHUB_ENV
          echo "ESTIMATED=${{ github.event.client_payload.count }}" >> $GITHUB_ENV

      - name: Show job info
        run: |
          echo "HLS Prefix: $PREFIX"
          echo "Estimated Files: $ESTIMATED"

      - name: Install AWS CLI v2 (official)
        run: |
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip awscliv2.zip
          sudo ./aws/install
          aws --version

      - name: Configure R2 credentials
        run: |
          aws configure set aws_access_key_id ${{ secrets.R2_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.R2_SECRET_ACCESS_KEY }}
          aws configure set default.region auto

      - name: Delete HLS folder from R2
        run: |
          ENDPOINT="https://${{ secrets.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com"

          echo "Starting HLS delete for prefix: $PREFIX"

          aws s3 rm \
            "s3://${{ secrets.R2_BUCKET_NAME }}/$PREFIX" \
            --recursive \
            --endpoint-url "$ENDPOINT"

          echo "âœ… HLS deletion completed"
