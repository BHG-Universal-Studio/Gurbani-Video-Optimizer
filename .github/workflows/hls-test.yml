name: HLS Test Conversion

on:
  repository_dispatch:
    types: [convert_hls]

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install FFmpeg
        run: |
          sudo apt update
          sudo apt install -y ffmpeg

      - name: Verify FFmpeg
        run: ffmpeg -version

      # ðŸ”½ Download video from Cloudflare (any format)
      - name: Download source video
        run: |
          echo "Downloading video from:"
          echo "${{ github.event.client_payload.video_url }}"

          curl -L "${{ github.event.client_payload.video_url }}" -o input_video

          echo "Downloaded file:"
          ls -lh input_video

      # ðŸŽ¥ Convert â†’ HLS (Compressed, 1080p max, SAFE)
      - name: Convert to HLS (1080p max, orientation-safe)
        run: |
          mkdir -p output_hls

          ffmpeg -y -i input_video \
            -vf "scale='if(gt(iw,ih),min(1920,iw),-2)':'if(gt(ih,iw),min(1080,ih),-2)':flags=lanczos,format=yuv420p" \
            -c:v libx264 \
            -profile:v baseline \
            -level 3.0 \
            -preset veryfast \
            -crf 23 \
            -g 48 \
            -keyint_min 48 \
            -sc_threshold 0 \
            -c:a aac \
            -b:a 128k \
            -ar 48000 \
            -hls_time 6 \
            -hls_playlist_type vod \
            -hls_list_size 0 \
            -hls_segment_filename "output_hls/index%03d.ts" \
            output_hls/index.m3u8

      - name: List HLS output
        run: ls -lh output_hls

      # ðŸ“¦ Make output downloadable (for testing)
      - name: Upload HLS output artifact
        uses: actions/upload-artifact@v4
        with:
          name: hls-output
          path: output_hls/
          retention-days: 1
